---
# Chore Tracking Package
#
# Tracks chore time for Charles and Gaby using a dual-button Aqara switch.
# Left button = Charles, Right button = Gaby
#
# Single press: starts/renews a session, accumulating minutes while active.
#   Sessions timeout after configured minutes of inactivity.
# Long press: activates extended chore mode which does not timeout.
#   A voice reminder plays every 5 minutes while extended mode is active.
#   Single press turns off extended chore mode.
#
# Device:
# - Aqara switch (chore control): eea20367040d6e9ad92eee3f0dc0ede2

input_boolean:
  chore_mode_charles:
    name: Chore Mode - Charles
    icon: mdi:broom
    initial: false

  chore_mode_gaby:
    name: Chore Mode - Gaby
    icon: mdi:broom
    initial: false

  extended_chore_mode_charles:
    name: Extended Chore Mode - Charles
    icon: mdi:broom
    initial: false

  extended_chore_mode_gaby:
    name: Extended Chore Mode - Gaby
    icon: mdi:broom
    initial: false

input_number:
  chore_timeout_minutes:
    name: Chore Timeout Duration
    min: 1
    max: 120
    step: 1
    initial: 5
    unit_of_measurement: min
    icon: mdi:timer-outline

  extended_chore_timeout_hours:
    name: Extended Chore Timeout Duration
    min: 1
    max: 24
    step: 0.5
    initial: 6
    unit_of_measurement: h
    icon: mdi:timer-outline

  chore_minutes_charles:
    name: Total Chore Minutes Charles
    min: 0
    max: 10000000
    step: 1
    icon: mdi:timer-sand

  chore_minutes_gaby:
    name: Total Chore Minutes Gaby
    min: 0
    max: 10000000
    step: 1
    icon: mdi:timer-sand

  extended_session_minutes_charles:
    name: Extended Session Minutes Charles
    min: 0
    max: 10000000
    step: 1
    icon: mdi:timer-sand

  extended_session_minutes_gaby:
    name: Extended Session Minutes Gaby
    min: 0
    max: 10000000
    step: 1
    icon: mdi:timer-sand

input_datetime:
  chore_last_activity_charles:
    name: Chore Last Activity - Charles
    has_date: true
    has_time: true
    icon: mdi:clock-outline

  chore_last_activity_gaby:
    name: Chore Last Activity - Gaby
    has_date: true
    has_time: true
    icon: mdi:clock-outline

  extended_chore_start_charles:
    name: Extended Chore Start - Charles
    has_date: true
    has_time: true
    icon: mdi:clock-start

  extended_chore_start_gaby:
    name: Extended Chore Start - Gaby
    has_date: true
    has_time: true
    icon: mdi:clock-start

# Template sensors to convert input_number to sensor domain for utility_meter
template:
  - sensor:
      - name: "Total Chore Minutes Charles"
        unique_id: chore_minutes_charles_sensor
        state: "{{ states('input_number.chore_minutes_charles') | float(0) }}"
        unit_of_measurement: "min"
        device_class: duration
        state_class: total_increasing
        icon: mdi:timer-sand
        availability: "{{ states('input_number.chore_minutes_charles') not in ['unknown', 'unavailable'] }}"

      - name: "Total Chore Minutes Gaby"
        unique_id: chore_minutes_gaby_sensor
        state: "{{ states('input_number.chore_minutes_gaby') | float(0) }}"
        unit_of_measurement: "min"
        device_class: duration
        state_class: total_increasing
        icon: mdi:timer-sand
        availability: "{{ states('input_number.chore_minutes_gaby') not in ['unknown', 'unavailable'] }}"

      - name: "Total Chore Minutes Combined"
        unique_id: chore_minutes_combined_sensor
        state: >
          {% set charles = states('input_number.chore_minutes_charles') | float(0) %}
          {% set gaby = states('input_number.chore_minutes_gaby') | float(0) %}
          {{ charles + gaby }}
        unit_of_measurement: "min"
        device_class: duration
        state_class: total_increasing
        icon: mdi:timer-sand
        availability: >
          {{ states('input_number.chore_minutes_charles') not in ['unknown', 'unavailable'] 
             and states('input_number.chore_minutes_gaby') not in ['unknown', 'unavailable'] }}

      # Weekly leader badge
      - name: "Chore Weekly Leader"
        unique_id: chore_weekly_leader
        state: >
          {% set charles_weekly = states('sensor.chore_minutes_charles_weekly') | float(0) %}
          {% set gaby_weekly = states('sensor.chore_minutes_gaby_weekly') | float(0) %}
          {% if charles_weekly > gaby_weekly %}
            Charles
          {% elif gaby_weekly > charles_weekly %}
            Gaby
          {% else %}
            Tied
          {% endif %}
        icon: mdi:trophy

      # Relative last activity times
      - name: "Charles Last Activity Relative"
        unique_id: charles_last_activity_relative
        state: >
          {% set last_activity = states('input_datetime.chore_last_activity_charles') %}
          {% if last_activity not in ['unknown', 'unavailable', ''] %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_ago = (now() - last_time).total_seconds() %}
            {% if seconds_ago < 60 %}
              Just now
            {% elif seconds_ago < 3600 %}
              {{ (seconds_ago / 60) | int }} minutes ago
            {% elif seconds_ago < 86400 %}
              {{ (seconds_ago / 3600) | int }} hours ago
            {% else %}
              {{ (seconds_ago / 86400) | int }} days ago
            {% endif %}
          {% else %}
            Never
          {% endif %}
        icon: mdi:clock-outline

      - name: "Gaby Last Activity Relative"
        unique_id: gaby_last_activity_relative
        state: >
          {% set last_activity = states('input_datetime.chore_last_activity_gaby') %}
          {% if last_activity not in ['unknown', 'unavailable', ''] %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_ago = (now() - last_time).total_seconds() %}
            {% if seconds_ago < 60 %}
              Just now
            {% elif seconds_ago < 3600 %}
              {{ (seconds_ago / 60) | int }} minutes ago
            {% elif seconds_ago < 86400 %}
              {{ (seconds_ago / 3600) | int }} hours ago
            {% else %}
              {{ (seconds_ago / 86400) | int }} days ago
            {% endif %}
          {% else %}
            Never
          {% endif %}
        icon: mdi:clock-outline

# Utility meters for daily, weekly, and monthly tracking
utility_meter:
  # For debug:
  chore_minutes_charles_quick:
    source: sensor.chore_minutes_charles
    cycle: quarter-hourly
  chore_minutes_gaby_quick:
    source: sensor.chore_minutes_gaby
    cycle: quarter-hourly

  chore_minutes_charles_daily:
    source: sensor.chore_minutes_charles
    cycle: daily
    offset:
      hours: 4

  chore_minutes_charles_weekly:
    source: sensor.chore_minutes_charles
    cycle: weekly
    offset:
      hours: 4
      days: 6

  chore_minutes_charles_monthly:
    source: sensor.chore_minutes_charles
    cycle: monthly
    offset:
      hours: 4

  chore_minutes_gaby_daily:
    source: sensor.chore_minutes_gaby
    cycle: daily
    offset:
      hours: 4

  chore_minutes_gaby_weekly:
    source: sensor.chore_minutes_gaby
    cycle: weekly
    offset:
      hours: 4
      days: 6

  chore_minutes_gaby_monthly:
    source: sensor.chore_minutes_gaby
    cycle: monthly
    offset:
      hours: 4

  chore_minutes_combined_quick:
    source: sensor.chore_minutes_combined
    cycle: quarter-hourly

  chore_minutes_combined_daily:
    source: sensor.chore_minutes_combined
    cycle: daily
    offset:
      hours: 4

  chore_minutes_combined_weekly:
    source: sensor.chore_minutes_combined
    cycle: weekly
    offset:
      hours: 4
      days: 6

  chore_minutes_combined_monthly:
    source: sensor.chore_minutes_combined
    cycle: monthly
    offset:
      hours: 4

automation:
  - id: "1763903316655"
    alias: Charles chore button - start/renew timer
    description: >-
      Left button on Aqara switch starts or renews Charles chore tracking
      session. If extended chore mode is active, turns it off instead.
    triggers:
      - domain: mqtt
        device_id: eea20367040d6e9ad92eee3f0dc0ede2
        type: action
        subtype: single_left
        trigger: device
    conditions: []
    actions:
      - if:
          - condition: state
            entity_id: input_boolean.extended_chore_mode_charles
            state: "on"
        then:
          # Turn off extended chore mode and regular chore mode
          - action: input_boolean.turn_off
            metadata: {}
            data: {}
            target:
              entity_id:
                - input_boolean.extended_chore_mode_charles
                - input_boolean.chore_mode_charles
          # Flash kitchen surface lights
          - action: script.flash_kitchen_surface_lights
            data: {}
        else:
          # Start/renew regular chore mode
          - action: input_boolean.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: input_boolean.chore_mode_charles
          - action: input_datetime.set_datetime
            metadata: {}
            data:
              datetime: "{{ now().isoformat() }}"
            target:
              entity_id: input_datetime.chore_last_activity_charles
          # Flash kitchen surface lights
          - action: script.flash_kitchen_surface_lights
            data: {}
    mode: single

  - id: "1763903316656"
    alias: Gaby chore button - start/renew timer
    description: >-
      Right button on Aqara switch starts or renews Gaby chore tracking
      session. If extended chore mode is active, turns it off instead.
    triggers:
      - domain: mqtt
        device_id: eea20367040d6e9ad92eee3f0dc0ede2
        type: action
        subtype: single_right
        trigger: device
    conditions: []
    actions:
      - if:
          - condition: state
            entity_id: input_boolean.extended_chore_mode_gaby
            state: "on"
        then:
          # Turn off extended chore mode and regular chore mode
          - action: input_boolean.turn_off
            metadata: {}
            data: {}
            target:
              entity_id:
                - input_boolean.extended_chore_mode_gaby
                - input_boolean.chore_mode_gaby
          # Flash kitchen surface lights
          - action: script.flash_kitchen_surface_lights
            data: {}
        else:
          # Start/renew regular chore mode
          - action: input_boolean.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: input_boolean.chore_mode_gaby
          - action: input_datetime.set_datetime
            metadata: {}
            data:
              datetime: "{{ now().isoformat() }}"
            target:
              entity_id: input_datetime.chore_last_activity_gaby
          # Flash kitchen surface lights
          - action: script.flash_kitchen_surface_lights
            data: {}
    mode: single

  - id: "1763903316668"
    alias: Charles chore mode activated - set last activity
    description: >-
      Set the last activity timestamp when Charles chore mode is activated,
      whether from button press or dashboard toggle.
    triggers:
      - trigger: state
        entity_id: input_boolean.chore_mode_charles
        from: "off"
        to: "on"
    conditions: []
    actions:
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          datetime: "{{ now().isoformat() }}"
        target:
          entity_id: input_datetime.chore_last_activity_charles
    mode: single

  - id: "1763903316669"
    alias: Gaby chore mode activated - set last activity
    description: >-
      Set the last activity timestamp when Gaby chore mode is activated,
      whether from button press or dashboard toggle.
    triggers:
      - trigger: state
        entity_id: input_boolean.chore_mode_gaby
        from: "off"
        to: "on"
    conditions: []
    actions:
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          datetime: "{{ now().isoformat() }}"
        target:
          entity_id: input_datetime.chore_last_activity_gaby
    mode: single

  - id: "1763903316657"
    alias: Charles chore accumulator
    description: "Add 1 minute to Charles chore counter every minute while chore mode is active"
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_charles
        state: "on"
    actions:
      - action: input_number.increment
        metadata: {}
        data: {}
        target:
          entity_id: input_number.chore_minutes_charles
      # Also track extended session minutes if in extended mode
      - if:
          - condition: state
            entity_id: input_boolean.extended_chore_mode_charles
            state: "on"
        then:
          - action: input_number.increment
            metadata: {}
            data: {}
            target:
              entity_id: input_number.extended_session_minutes_charles
    mode: single

  - id: "1763903316658"
    alias: Gaby chore accumulator
    description: "Add 1 minute to Gaby chore counter every minute while chore mode is active"
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_gaby
        state: "on"
    actions:
      - action: input_number.increment
        metadata: {}
        data: {}
        target:
          entity_id: input_number.chore_minutes_gaby
      # Also track extended session minutes if in extended mode
      - if:
          - condition: state
            entity_id: input_boolean.extended_chore_mode_gaby
            state: "on"
        then:
          - action: input_number.increment
            metadata: {}
            data: {}
            target:
              entity_id: input_number.extended_session_minutes_gaby
    mode: single

  - id: "1763903316659"
    alias: Charles chore timeout
    description: >-
      Disable Charles chore mode after configured timeout period of inactivity.
      Does not timeout if extended chore mode is active.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_charles
        state: "on"
      - condition: state
        entity_id: input_boolean.extended_chore_mode_charles
        state: "off"
      - condition: template
        value_template: >
          {% set last_activity = states('input_datetime.chore_last_activity_charles') %}
          {% if last_activity not in ['unknown', 'unavailable', ''] %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_elapsed = (now() - last_time).total_seconds() %}
            {% set timeout_seconds = states('input_number.chore_timeout_minutes') | float * 60 %}
            {{ seconds_elapsed > timeout_seconds }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.chore_mode_charles
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316660"
    alias: Gaby chore timeout
    description: >-
      Disable Gaby chore mode after configured timeout period of inactivity.
      Does not timeout if extended chore mode is active.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_gaby
        state: "on"
      - condition: state
        entity_id: input_boolean.extended_chore_mode_gaby
        state: "off"
      - condition: template
        value_template: >
          {% set last_activity = states('input_datetime.chore_last_activity_gaby') %}
          {% if last_activity not in ['unknown', 'unavailable', ''] %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_elapsed = (now() - last_time).total_seconds() %}
            {% set timeout_seconds = states('input_number.chore_timeout_minutes') | float * 60 %}
            {{ seconds_elapsed > timeout_seconds }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.chore_mode_gaby
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316661"
    alias: Charles chore timeout warning
    description: >-
      Flash lights once as warning 1 minute before Charles chore mode times out.
      Does not warn if extended chore mode is active.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_charles
        state: "on"
      - condition: state
        entity_id: input_boolean.extended_chore_mode_charles
        state: "off"
      - condition: template
        value_template: >
          {% set last_activity = states('input_datetime.chore_last_activity_charles') %}
          {% set timeout_minutes = states('input_number.chore_timeout_minutes') | float %}
          {% if last_activity not in ['unknown', 'unavailable', ''] and timeout_minutes > 1 %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_elapsed = (now() - last_time).total_seconds() %}
            {% set timeout_seconds = timeout_minutes * 60 %}
            {% set warning_start = timeout_seconds - 60 %}
            {{ seconds_elapsed >= warning_start and seconds_elapsed < timeout_seconds }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: script.flash_kitchen_surface_lights_once
        data: {}
    mode: single

  - id: "1763903316662"
    alias: Gaby chore timeout warning
    description: >-
      Flash lights once as warning 1 minute before Gaby chore mode times out.
      Does not warn if extended chore mode is active.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.chore_mode_gaby
        state: "on"
      - condition: state
        entity_id: input_boolean.extended_chore_mode_gaby
        state: "off"
      - condition: template
        value_template: >
          {% set last_activity = states('input_datetime.chore_last_activity_gaby') %}
          {% set timeout_minutes = states('input_number.chore_timeout_minutes') | float %}
          {% if last_activity not in ['unknown', 'unavailable', ''] and timeout_minutes > 1 %}
            {% set last_time = last_activity | as_datetime | as_local %}
            {% set seconds_elapsed = (now() - last_time).total_seconds() %}
            {% set timeout_seconds = timeout_minutes * 60 %}
            {% set warning_start = timeout_seconds - 60 %}
            {{ seconds_elapsed >= warning_start and seconds_elapsed < timeout_seconds }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: script.flash_kitchen_surface_lights_once
        data: {}
    mode: single

  - id: "1763903316663"
    alias: Charles chore button - start extended mode
    description: >-
      Long press on left button activates extended chore mode for Charles.
      Extended chore mode times out after configured hours (see input_number.extended_chore_timeout_hours).
    triggers:
      - domain: mqtt
        device_id: eea20367040d6e9ad92eee3f0dc0ede2
        type: action
        subtype: double_left
        trigger: device
    conditions: []
    actions:
      - action: input_boolean.turn_on
        metadata: {}
        data: {}
        target:
          entity_id:
            - input_boolean.chore_mode_charles
            - input_boolean.extended_chore_mode_charles
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          datetime: "{{ now().isoformat() }}"
        target:
          entity_id: input_datetime.extended_chore_start_charles
      - action: input_number.set_value
        metadata: {}
        data:
          value: 0
        target:
          entity_id: input_number.extended_session_minutes_charles
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316664"
    alias: Gaby chore button - start extended mode
    description: >-
      Long press on right button activates extended chore mode for Gaby.
      Extended chore mode times out after configured hours (see input_number.extended_chore_timeout_hours).
    triggers:
      - domain: mqtt
        device_id: eea20367040d6e9ad92eee3f0dc0ede2
        type: action
        subtype: double_right
        trigger: device
    conditions: []
    actions:
      - action: input_boolean.turn_on
        metadata: {}
        data: {}
        target:
          entity_id:
            - input_boolean.chore_mode_gaby
            - input_boolean.extended_chore_mode_gaby
      - action: input_datetime.set_datetime
        metadata: {}
        data:
          datetime: "{{ now().isoformat() }}"
        target:
          entity_id: input_datetime.extended_chore_start_gaby
      - action: input_number.set_value
        metadata: {}
        data:
          value: 0
        target:
          entity_id: input_number.extended_session_minutes_gaby
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316666"
    alias: Extended chore mode announcement
    description: >-
      Announce on speaker when extended chore mode is activated for either
      Charles or Gaby.
    triggers:
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_charles
        from: "off"
        to: "on"
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_gaby
        from: "off"
        to: "on"
    conditions: []
    actions:
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            {% if trigger.entity_id == 'input_boolean.extended_chore_mode_charles' %}
            Extended chore mode activated for Charles
            {% elif trigger.entity_id == 'input_boolean.extended_chore_mode_gaby' %}
            Extended chore mode activated for Gaby
            {% endif %}
        target:
          entity_id: tts.google_translate_en_com
    mode: single

  - id: "1763903316667"
    alias: Extended chore mode deactivation announcement
    description: >-
      Announce on speaker when extended chore mode is deactivated for either
      Charles or Gaby.
    triggers:
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_charles
        from: "on"
        to: "off"
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_gaby
        from: "on"
        to: "off"
    conditions: []
    actions:
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            {% if trigger.entity_id == 'input_boolean.extended_chore_mode_charles' %}
            Extended chore mode deactivated for Charles
            {% elif trigger.entity_id == 'input_boolean.extended_chore_mode_gaby' %}
            Extended chore mode deactivated for Gaby
            {% endif %}
        target:
          entity_id: tts.google_translate_en_com
    mode: single

  - id: "1763903316674"
    alias: Charles extended chore mode deactivated - reset session counter
    description: >-
      Reset the session minutes counter when Charles extended chore mode
      is deactivated (either manually or by timeout).
    triggers:
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_charles
        from: "on"
        to: "off"
    conditions: []
    actions:
      - action: input_number.set_value
        metadata: {}
        data:
          value: 0
        target:
          entity_id: input_number.extended_session_minutes_charles
    mode: single

  - id: "1763903316675"
    alias: Gaby extended chore mode deactivated - reset session counter
    description: >-
      Reset the session minutes counter when Gaby extended chore mode
      is deactivated (either manually or by timeout).
    triggers:
      - trigger: state
        entity_id: input_boolean.extended_chore_mode_gaby
        from: "on"
        to: "off"
    conditions: []
    actions:
      - action: input_number.set_value
        metadata: {}
        data:
          value: 0
        target:
          entity_id: input_number.extended_session_minutes_gaby
    mode: single

  - id: "1763903316665"
    alias: Extended chore mode reminder
    description: >-
      Announce every 5 minutes while extended chore mode is active for either
      Charles or Gaby.
    triggers:
      - trigger: time_pattern
        minutes: /5
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.extended_chore_mode_charles
            state: "on"
          - condition: state
            entity_id: input_boolean.extended_chore_mode_gaby
            state: "on"
    actions:
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            {% set charles = is_state('input_boolean.extended_chore_mode_charles', 'on') %}
            {% set gaby = is_state('input_boolean.extended_chore_mode_gaby', 'on') %}
            {% if charles and gaby %}
            Reminder: extended chore mode is active for Charles and Gaby
            {% elif charles %}
            Reminder: extended chore mode is active for Charles
            {% else %}
            Reminder: extended chore mode is active for Gaby
            {% endif %}
        target:
          entity_id: tts.google_translate_en_com
    mode: single

  - id: "1763903316670"
    alias: Charles extended chore mode timeout warning
    description: >-
      Warn 30 minutes before Charles extended chore mode times out.
      Extended mode timeout is configurable via input_number.extended_chore_timeout_hours.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.extended_chore_mode_charles
        state: "on"
      - condition: template
        value_template: >
          {% set start_time = states('input_datetime.extended_chore_start_charles') %}
          {% if start_time not in ['unknown', 'unavailable', ''] %}
            {% set start = start_time | as_datetime | as_local %}
            {% set elapsed_minutes = ((now() - start).total_seconds() / 60) | int %}
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            {% set timeout_minutes = (timeout_hours * 60) | int %}
            {% set warning_minutes = timeout_minutes - 30 %}
            {{ elapsed_minutes >= warning_minutes and elapsed_minutes < timeout_minutes }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            Warning: Charles extended chore mode will timeout in 30 minutes.
            Press the button to save your progress.
        target:
          entity_id: tts.google_translate_en_com
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316671"
    alias: Gaby extended chore mode timeout warning
    description: >-
      Warn 30 minutes before Gaby extended chore mode times out.
      Extended mode timeout is configurable via input_number.extended_chore_timeout_hours.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.extended_chore_mode_gaby
        state: "on"
      - condition: template
        value_template: >
          {% set start_time = states('input_datetime.extended_chore_start_gaby') %}
          {% if start_time not in ['unknown', 'unavailable', ''] %}
            {% set start = start_time | as_datetime | as_local %}
            {% set elapsed_minutes = ((now() - start).total_seconds() / 60) | int %}
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            {% set timeout_minutes = (timeout_hours * 60) | int %}
            {% set warning_minutes = timeout_minutes - 30 %}
            {{ elapsed_minutes >= warning_minutes and elapsed_minutes < timeout_minutes }}
          {% else %}
            false
          {% endif %}
    actions:
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            Warning: Gaby extended chore mode will timeout in 30 minutes.
            Press the button to save your progress.
        target:
          entity_id: tts.google_translate_en_com
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316672"
    alias: Charles extended chore mode timeout
    description: >-
      Timeout Charles extended chore mode after configured hours and remove all
      minutes accumulated during the session.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.extended_chore_mode_charles
        state: "on"
      - condition: template
        value_template: >
          {% set start_time = states('input_datetime.extended_chore_start_charles') %}
          {% if start_time not in ['unknown', 'unavailable', ''] %}
            {% set start = start_time | as_datetime | as_local %}
            {% set elapsed_minutes = ((now() - start).total_seconds() / 60) | int %}
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            {% set timeout_minutes = (timeout_hours * 60) | int %}
            {{ elapsed_minutes >= timeout_minutes }}
          {% else %}
            false
          {% endif %}
    actions:
      # Subtract the session minutes from total
      - action: input_number.set_value
        metadata: {}
        data:
          value: >
            {% set current = states('input_number.chore_minutes_charles') | float(0) %}
            {% set session = states('input_number.extended_session_minutes_charles') | float(0) %}
            {{ [0, current - session] | max }}
        target:
          entity_id: input_number.chore_minutes_charles
      # Turn off extended chore mode and regular chore mode
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id:
            - input_boolean.extended_chore_mode_charles
            - input_boolean.chore_mode_charles
      # Announce timeout
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            Extended chore mode timed out for Charles after {{ timeout_hours }} hours.
            Session minutes have been removed.
        target:
          entity_id: tts.google_translate_en_com
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single

  - id: "1763903316673"
    alias: Gaby extended chore mode timeout
    description: >-
      Timeout Gaby extended chore mode after configured hours and remove all
      minutes accumulated during the session.
    triggers:
      - trigger: time_pattern
        minutes: /1
    conditions:
      - condition: state
        entity_id: input_boolean.extended_chore_mode_gaby
        state: "on"
      - condition: template
        value_template: >
          {% set start_time = states('input_datetime.extended_chore_start_gaby') %}
          {% if start_time not in ['unknown', 'unavailable', ''] %}
            {% set start = start_time | as_datetime | as_local %}
            {% set elapsed_minutes = ((now() - start).total_seconds() / 60) | int %}
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            {% set timeout_minutes = (timeout_hours * 60) | int %}
            {{ elapsed_minutes >= timeout_minutes }}
          {% else %}
            false
          {% endif %}
    actions:
      # Subtract the session minutes from total
      - action: input_number.set_value
        metadata: {}
        data:
          value: >
            {% set current = states('input_number.chore_minutes_gaby') | float(0) %}
            {% set session = states('input_number.extended_session_minutes_gaby') | float(0) %}
            {{ [0, current - session] | max }}
        target:
          entity_id: input_number.chore_minutes_gaby
      # Turn off extended chore mode and regular chore mode
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id:
            - input_boolean.extended_chore_mode_gaby
            - input_boolean.chore_mode_gaby
      # Announce timeout
      - action: tts.speak
        metadata: {}
        data:
          cache: true
          media_player_entity_id: media_player.living_room_speaker
          message: >-
            {% set timeout_hours = states('input_number.extended_chore_timeout_hours') | float(6) %}
            Extended chore mode timed out for Gaby after {{ timeout_hours }} hours.
            Session minutes have been removed.
        target:
          entity_id: tts.google_translate_en_com
      # Flash kitchen surface lights
      - action: script.flash_kitchen_surface_lights
        data: {}
    mode: single
