---
# Bedroom Climate Control Package
#
# PID-controlled TRV system for bedroom heating.
# Uses external temperature sensor and smart_thermostat integration.
#
# Components:
# - PID controller climate entity
# - Helper for valve position (0-100)
# - Valve position sync automation (blueprint)
# - External sensor sync automation (blueprint)
# - Bidirectional setpoint sync (physical TRV â†” PID controller)
#
# Physical device: climate.trv_bedroom
# External sensor: sensor.sensor_bedroom_temperature
#
# Blueprints used:
# - arnie580/sonoff-trv-pid.yaml
# - photomoose/sonoff-trvzb-external-temperature-sensor-calibration.yaml

input_number:
  bedroom_trv_valve_position:
    name: Bedroom TRV Valve Position
    initial: 0
    min: 0
    max: 100
    step: 1

input_boolean:
  boost_mode_bedroom:
    name: Boost Mode - Bedroom
    icon: mdi:rocket-launch
    initial: false

input_datetime:
  boost_start_bedroom:
    name: Boost Start - Bedroom
    has_date: true
    has_time: true
    icon: mdi:clock-start

button:
  - platform: template
    buttons:
      boost_bedroom:
        unique_id: boost_button_bedroom
        friendly_name: "Boost Bedroom"
        icon_template: mdi:rocket-launch
        press:
          - action: input_boolean.toggle
            target:
              entity_id: input_boolean.boost_mode_bedroom

climate:
  - platform: smart_thermostat
    name: Bedroom TRV PID controller
    unique_id: trv_pid_bedroom
    heater: input_number.bedroom_trv_valve_position
    target_sensor: sensor.sensor_bedroom_temperature
    min_temp: 7
    max_temp: 28
    ac_mode: False
    target_temp: 19
    keep_alive:
      seconds: 60
    kp: 60
    ki: 0.01
    kd: 2000
    pwm: 0

automation:
  - id: '1731536616000'
    alias: Bedroom TRV - sync valve with helper
    description: 'Copy the settings from the 0 - 100 helper to the TRV valve position.
      This will be controlled by a PID controller from Smart thermostat (PID) - see
      the YAML. '
    use_blueprint:
      path: arnie580/sonoff-trv-pid.yaml
      input:
        thermostat_value: input_number.bedroom_trv_valve_position
        max_valve_opening: number.trv_bedroom_valve_opening_degree
        max_valve_closing: number.trv_bedroom_valve_closing_degree

  - id: '1732304000000'
    alias: Sync bedroom TRV with external sensor
    description: ''
    use_blueprint:
      path: photomoose/sonoff-trvzb-external-temperature-sensor-calibration.yaml
      input:
        external_temperature_sensor: sensor.sensor_bedroom_temperature
        trv_external_temperature_input:
        - number.trv_bedroom_external_temperature_input

  - id: '1732372800004'
    alias: Bedroom TRV - sync physical setpoint to PID
    description: 'When user changes setpoint on physical TRV, copy it to the PID controller'
    triggers:
    - trigger: state
      entity_id: climate.trv_bedroom
      attribute: temperature
    conditions:
    - condition: template
      value_template: >
        {% set trv_temp = state_attr('climate.trv_bedroom', 'temperature') %}
        {% set pid_temp = state_attr('climate.bedroom_trv_pid_controller', 'temperature') %}
        {{ trv_temp != none and pid_temp != none and trv_temp != pid_temp }}
    actions:
    - action: climate.set_temperature
      metadata: {}
      data:
        temperature: >
          {{ state_attr('climate.trv_bedroom', 'temperature') }}
      target:
        entity_id: climate.bedroom_trv_pid_controller
    mode: single

  - id: '1732372800005'
    alias: Bedroom TRV - sync PID setpoint to physical
    description: 'When user changes setpoint on PID controller, copy it to the physical TRV'
    triggers:
    - trigger: state
      entity_id: climate.bedroom_trv_pid_controller
      attribute: temperature
    conditions:
    - condition: template
      value_template: >
        {% set trv_temp = state_attr('climate.trv_bedroom', 'temperature') %}
        {% set pid_temp = state_attr('climate.bedroom_trv_pid_controller', 'temperature') %}
        {{ trv_temp != none and pid_temp != none and trv_temp != pid_temp }}
    actions:
    - action: climate.set_temperature
      metadata: {}
      data:
        temperature: >
          {{ state_attr('climate.bedroom_trv_pid_controller', 'temperature') }}
      target:
        entity_id: climate.trv_bedroom
    mode: single

  - id: '1736044800006'
    alias: Bedroom TRV - activate boost mode
    description: 'When boost mode is activated, set valve to 100% and stop PID updates'
    triggers:
    - trigger: state
      entity_id: input_boolean.boost_mode_bedroom
      to: 'on'
    conditions: []
    actions:
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.boost_start_bedroom
      data:
        timestamp: '{{ now().timestamp() }}'
    - action: automation.turn_off
      target:
        entity_id: automation.bedroom_trv_sync_valve_with_helper
      data:
        stop_actions: false
    - action: input_number.set_value
      target:
        entity_id: input_number.bedroom_trv_valve_position
      data:
        value: 100
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.bedroom_trv_pid_controller
      data:
        hvac_mode: 'off'
    mode: single

  - id: '1736044800007'
    alias: Bedroom TRV - deactivate boost mode
    description: 'When boost mode is turned off, restore PID control'
    triggers:
    - trigger: state
      entity_id: input_boolean.boost_mode_bedroom
      to: 'off'
    conditions: []
    actions:
    - action: automation.turn_on
      target:
        entity_id: automation.bedroom_trv_sync_valve_with_helper
    - action: climate.set_hvac_mode
      target:
        entity_id: climate.bedroom_trv_pid_controller
      data:
        hvac_mode: 'heat'
    mode: single

  - id: '1736044800008'
    alias: Bedroom TRV - boost timeout
    description: 'Turn off boost mode after 1 hour'
    triggers:
    - trigger: time_pattern
      minutes: /1
    conditions:
    - condition: state
      entity_id: input_boolean.boost_mode_bedroom
      state: 'on'
    - condition: template
      value_template: >
        {% set boost_start = states('input_datetime.boost_start_bedroom') %}
        {% if boost_start not in ['unknown', 'unavailable', ''] %}
          {% set start_time = as_timestamp(boost_start) %}
          {% set current_time = now().timestamp() %}
          {{ (current_time - start_time) >= 3600 }}
        {% else %}
          false
        {% endif %}
    actions:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.boost_mode_bedroom
    mode: single
