- sensor:
    - name: Gaby sleep probability
      state: >
        {{ (100 * state_attr('binary_sensor.gaby_sleeping_bayesian', 'probability')|float)|int }}%
      icon: mdi:sleep
      state_class: measurement
- sensor:
    - name: Charles sleep probability
      state: >
        {{ (100 * state_attr('binary_sensor.charles_sleeping_bayesian', 'probability')|float)|int }}%
      icon: mdi:sleep
      state_class: measurement
# - sensor:
#     - name: Gaby sleep state
#       state: >
#         {% set sensor = 'binary_sensor.gaby_sleeping_bayesian' %}
#         {% set since = relative_time(states.binary_sensor.gaby_sleeping_bayesian.last_changed) %}
#         {# Without this, the sensor will not update: #}
#         {% set bump = now() %}
#         {% if is_state(sensor, 'on') %}
#           Asleep {{since}}
#         {% elif is_state(sensor, 'off') %}
#           Awake {{since}}
#         {% else %}
#           Error
#         {% endif %}
- sensor:
    - name: Time since last vacuum
      state: >
        {% set bump = now() %}
        {% if is_state('vacuum.noonoo', 'docked') %}
        {{ relative_time(as_datetime(states('sensor.noonoo_last_clean_end'))) }}
        {% else %}
        {{ states('vacuum.noonoo') }}
        {% endif %}
- sensor:
    - name: Dishwasher state
      state: >
        {% set dishwasher_power = states('sensor.dishwasher_energy_power')|float %}
        {% if dishwasher_power > 10 %}
        running
        {% elif dishwasher_power > 1 %}
        standby
        {% else %}
        off
        {% endif %}
      icon: >
        {% set dishwasher_state = states('sensor.dishwasher_state') %}
        {% if dishwasher_state == "off" %}
        mdi:dishwasher-off
        {% elif dishwasher_state == "standby" %}
        mdi:dishwasher-alert
        {% elif dishwasher_state == "running" %}
        mdi:dishwasher
        {% else %}
        mdi:alert-circle
        {% endif %}

# Store current total number of trips in a template variable,
# updated monthly (by an automation firing an event)
- sensor:
    name: Charles total trips at month start
    state: "{{ states('counter.charles_number_saved_train_journeys')|float }}"
  trigger:
    - platform: event
      event_type: "RESET_BICYCLE_MONTHLY_COUNTS"
# Calculate total saved
- sensor:
    - name: Charles total saved via eBike
      unit_of_measurement: "£"
      state: >
        {{
        (states('counter.charles_number_saved_train_journeys')|float)
        *
        (states('input_number.charles_oneway_train_cost')|float)
        }}
      state_class: total_increasing
      device_class: monetary
# Calculate total saved since start of month
- sensor:
    - name: Charles total saved this month
      state_class: total_increasing
      device_class: monetary
      unit_of_measurement: "£"
      state: >
        {{
          (
            (states('counter.charles_number_saved_train_journeys')|float)
            - 
            (states('sensor.charles_total_trips_at_month_start')|float)
          ) * 
          (states('input_number.charles_oneway_train_cost')|float)
        }}

# Store current total number of trips in a template variable,
# updated monthly (by an automation firing an event)
- sensor:
    name: Gaby total trips at month start
    state: "{{ states('counter.gaby_number_saved_train_journeys')|float }}"
  trigger:
    - platform: event
      event_type: "RESET_BICYCLE_MONTHLY_COUNTS"
# Calculate total saved
- sensor:
    - name: Gaby total saved via eBike
      unit_of_measurement: "£"
      state: >
        {{
        (states('counter.gaby_number_saved_train_journeys')|float)
        *
        (states('input_number.gaby_oneway_train_cost')|float)
        }}
      state_class: total_increasing
      device_class: monetary
# Calculate total saved since start of month
- sensor:
    - name: Gaby total saved this month
      state_class: total_increasing
      device_class: monetary
      unit_of_measurement: "£"
      state: >
        {{
          (
            (states('counter.gaby_number_saved_train_journeys')|float)
            - 
            (states('sensor.gaby_total_trips_at_month_start')|float)
          ) * 
          (states('input_number.gaby_oneway_train_cost')|float)
        }}
